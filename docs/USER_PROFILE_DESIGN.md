# 用户 Profile 功能设计文档

## 概述

本文档描述了 Candy AI 项目中用户 Profile 管理功能的完整设计，包括邮箱和手机验证、绑定、解绑、换绑等功能。

## 功能需求

### 1. 邮箱管理功能

#### 1.1 邮箱验证状态
- **未验证状态** (`emailVerified = 0`)：用户邮箱未通过验证
- **已验证状态** (`emailVerified = 1`)：用户邮箱已通过验证

#### 1.2 邮箱注册验证
- 用户通过邮箱注册时，系统自动发送验证码到注册邮箱
- 用户输入验证码验证后，邮箱状态标记为已验证
- 第三方登录（Google、GitHub、Discord、Apple、Facebook）注册的用户，邮箱自动标记为已验证

#### 1.3 邮箱换绑流程
1. **发送原邮箱验证码**：系统向用户当前绑定的邮箱发送验证码
2. **验证原邮箱**：用户输入原邮箱验证码进行验证
3. **输入新邮箱**：用户输入新的邮箱地址
4. **发送新邮箱验证码**：系统向新邮箱发送验证码
5. **验证新邮箱**：用户输入新邮箱验证码
6. **完成换绑**：验证成功后，更新用户邮箱地址

#### 1.4 邮箱解绑
- 用户可以选择解绑当前邮箱
- 解绑后，邮箱字段清空，验证状态重置为未验证

### 2. 手机管理功能

#### 2.1 手机验证状态
- **未验证状态** (`phoneVerified = 0`)：用户手机号未通过验证
- **已验证状态** (`phoneVerified = 1`)：用户手机号已通过验证

#### 2.2 手机绑定流程
1. **输入手机号**：用户输入要绑定的手机号
2. **发送验证码**：系统向手机号发送验证码
3. **输入验证码**：用户输入收到的验证码
4. **完成绑定**：验证成功后，绑定手机号

#### 2.3 手机换绑流程
1. **输入新手机号**：用户输入新的手机号
2. **发送验证码**：系统向新手机号发送验证码
3. **输入验证码**：用户输入收到的验证码
4. **完成换绑**：验证成功后，更新用户手机号

#### 2.4 手机解绑
- 用户可以选择解绑当前手机号
- 解绑后，手机号字段清空，验证状态重置为未验证

## 数据库设计

### SysUser 表扩展字段

```sql
-- 邮箱验证相关字段
email_verified INT DEFAULT 0 COMMENT '邮箱验证状态（0未验证 1已验证）',
email_verify_code VARCHAR(10) COMMENT '邮箱验证码',
email_verify_expire DATETIME COMMENT '邮箱验证码过期时间',

-- 手机验证相关字段
phone_verified INT DEFAULT 0 COMMENT '手机验证状态（0未验证 1已验证）',
phone_verify_code VARCHAR(10) COMMENT '手机验证码',
phone_verify_expire DATETIME COMMENT '手机验证码过期时间',

-- 邮箱换绑相关字段
old_email_verify_code VARCHAR(10) COMMENT '原邮箱验证码（用于换绑验证）',
old_email_verify_expire DATETIME COMMENT '原邮箱验证码过期时间',
new_email_verify_code VARCHAR(10) COMMENT '新邮箱验证码（用于换绑验证）',
new_email_verify_expire DATETIME COMMENT '新邮箱验证码过期时间',
```

## API 接口设计

### 1. 基本信息管理

#### 1.1 获取用户 Profile 信息
```
GET /api/user/profile/info
```
- 返回用户基本信息（隐藏敏感信息如密码、验证码）
- 包含邮箱和手机验证状态

#### 1.2 更新用户基本信息
```
PUT /api/user/profile/update
```
- 更新用户昵称、性别等基本信息
- 不允许更新邮箱、手机号等敏感信息

#### 1.3 更新用户头像
```
POST /api/user/profile/updateAvatar
```
- 更新用户头像URL

### 2. 邮箱管理接口

#### 2.1 发送原邮箱验证码
```
POST /api/user/profile/sendOldEmailVerifyCode
```
- 向用户当前绑定的邮箱发送验证码
- 用于邮箱换绑流程

#### 2.2 发送新邮箱验证码
```
POST /api/user/profile/sendNewEmailVerifyCode?newEmail={email}
```
- 向新邮箱地址发送验证码
- 用于邮箱换绑流程

#### 2.3 验证原邮箱验证码
```
POST /api/user/profile/verifyOldEmailCode?verifyCode={code}
```
- 验证原邮箱验证码
- 验证成功后清除验证码

#### 2.4 验证新邮箱验证码并换绑
```
POST /api/user/profile/verifyNewEmailAndUpdate?newEmail={email}&verifyCode={code}
```
- 验证新邮箱验证码
- 验证成功后更新邮箱地址并标记为已验证

#### 2.5 解绑邮箱
```
POST /api/user/profile/unbindEmail
```
- 解绑当前邮箱
- 清除邮箱相关字段和验证状态

### 3. 手机管理接口

#### 3.1 发送手机验证码
```
POST /api/user/profile/sendPhoneVerifyCode?phoneNumber={phone}
```
- 向手机号发送验证码
- 用于手机绑定流程

#### 3.2 验证手机验证码并绑定
```
POST /api/user/profile/verifyPhoneAndBind?phoneNumber={phone}&verifyCode={code}
```
- 验证手机验证码
- 验证成功后绑定手机号并标记为已验证

#### 3.3 发送手机换绑验证码
```
POST /api/user/profile/sendPhoneChangeVerifyCode?newPhoneNumber={phone}
```
- 向新手机号发送验证码
- 用于手机换绑流程

#### 3.4 验证手机验证码并换绑
```
POST /api/user/profile/verifyPhoneAndChange?newPhoneNumber={phone}&verifyCode={code}
```
- 验证手机验证码
- 验证成功后更新手机号并标记为已验证

#### 3.5 解绑手机
```
POST /api/user/profile/unbindPhone
```
- 解绑当前手机号
- 清除手机号相关字段和验证状态

### 4. 可用性检查接口

#### 4.1 检查邮箱是否可用
```
GET /api/user/profile/checkEmail?email={email}
```
- 检查邮箱是否已被其他用户使用
- 返回可用性状态

#### 4.2 检查手机号是否可用
```
GET /api/user/profile/checkPhone?phoneNumber={phone}
```
- 检查手机号是否已被其他用户使用
- 返回可用性状态

## 验证码规则

### 1. 验证码格式
- 6位数字验证码
- 随机生成，确保安全性

### 2. 验证码有效期
- **邮箱验证码**：10分钟
- **手机验证码**：5分钟

### 3. 验证码存储
- 验证码存储在用户表中
- 验证成功后立即清除验证码
- 过期后自动失效

## 安全考虑

### 1. 验证码安全
- 验证码有效期限制
- 验证成功后立即清除
- 防止暴力破解

### 2. 邮箱和手机号唯一性
- 确保邮箱和手机号在系统中唯一
- 换绑时检查新地址是否已被使用

### 3. 用户身份验证
- 所有 Profile 操作需要用户登录
- 只能操作自己的 Profile 信息

### 4. 数据验证
- 邮箱格式验证
- 手机号格式验证（中国大陆手机号）
- 输入数据长度限制

## 前端集成建议

### 1. 邮箱换绑流程
```
1. 用户点击"换绑邮箱"
2. 显示当前邮箱地址
3. 点击"发送验证码"按钮
4. 输入原邮箱验证码
5. 验证成功后，显示新邮箱输入框
6. 输入新邮箱地址
7. 点击"发送验证码"按钮
8. 输入新邮箱验证码
9. 完成换绑
```

### 2. 手机绑定流程
```
1. 用户点击"绑定手机"
2. 输入手机号
3. 点击"发送验证码"按钮
4. 输入验证码
5. 完成绑定
```

### 3. 状态显示
- 显示邮箱和手机验证状态
- 未验证状态显示"未验证"标识
- 已验证状态显示"已验证"标识

## 测试用例

### 1. 功能测试
- 邮箱换绑完整流程测试
- 手机绑定完整流程测试
- 解绑功能测试
- 验证码过期测试
- 重复绑定测试

### 2. 安全测试
- 验证码暴力破解测试
- 未授权访问测试
- 数据验证测试

### 3. 集成测试
- 与邮件服务集成测试
- 与短信服务集成测试
- 前端界面集成测试

## 部署注意事项

### 1. 邮件服务配置
- 配置 SMTP 服务器
- 设置发件人邮箱
- 配置邮件模板

### 2. 短信服务配置
- 配置短信服务商
- 设置短信模板
- 配置发送限制

### 3. 数据库更新
- 执行数据库字段扩展脚本
- 更新现有用户数据

## 总结

本设计提供了完整的用户 Profile 管理功能，包括：

1. **完整的验证流程**：邮箱和手机的双重验证机制
2. **灵活的绑定管理**：支持绑定、解绑、换绑操作
3. **安全的数据保护**：验证码有效期、唯一性检查等
4. **友好的用户体验**：清晰的状态标识和操作流程
5. **可扩展的架构**：支持未来功能扩展

该设计确保了用户账户的安全性和数据的完整性，同时提供了良好的用户体验。 